<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Livre Acesso - Gestão Beneficiários</title>

    <link rel="stylesheet" href="../../styles/gestao/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <custom-navbar></custom-navbar>
    <script src="../../components/navbar.js"></script>

    <global-loader></global-loader>
    <script src="../../scripts/utils/utils.js"></script>

    <script type="module">
        import { getProfile, loadTokenOnStart, logout } from "../../services/auth.js";

        // Variável global para guardar o usuário (para usar no modal depois)
        let currentUser = null;

        document.addEventListener("DOMContentLoaded", async () => {
            // Inicializa ícones
            feather.replace();

            // Carrega token
            loadTokenOnStart();

            try {
                // 1. Busca dados do usuário logado
                const user = await getProfile(); 
                currentUser = user; // Salva na variável global
                console.log("Usuário Admin Logado:", user);

                // 2. Preenche o Card do Topo (Header)
                if (user) {
                    const nomeEl = document.getElementById("header-user-name");
                    const emailEl = document.getElementById("header-user-email");

                    // Usa o nome ou fallback
                    if (nomeEl) nomeEl.textContent = user.nome || "Administrador";
                    if (emailEl) emailEl.textContent = user.email || "email@sistema.com";
                }

            } catch (err) {
                console.error("Falha ao buscar profile:", err);
                if (err?.status === 401) logout();
            }

            // 3. Lógica para preencher o "Gestor" dentro do Modal de Visualização
            const viewModal = document.getElementById('viewModal');
            if (viewModal) {
                // O evento 'show.bs.modal' dispara assim que o modal é chamado
                viewModal.addEventListener('show.bs.modal', function () {
                    const gestorSpan = document.getElementById('view-gestor');
                    if (gestorSpan && currentUser) {
                        // Preenche com o nome do admin logado
                        gestorSpan.textContent = "Gestor: " + (currentUser.nome || "Admin");
                        // Opcional: Adicionar estilo de badge
                        gestorSpan.className = "text-sm badge bg-primary text-white"; 
                    }
                });
            }
        });
    </script>

    <main class="container mx-auto px-4 py-8">
        
        <div class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-4 border-b pb-4">
            
            <h1 class="text-3xl font-bold text-blue-600 text-center lg:text-left m-0" style="color: #21409A">
                Beneficiários PE Livre Acesso Intermunicipal
            </h1>

            <div class="bg-white border border-gray-200 px-4 py-2 rounded-lg flex items-center shadow-sm min-w-[250px]">
                <div class="bg-blue-100 p-2 rounded-full mr-3 flex items-center justify-center">
                    <i data-feather="user" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div class="flex flex-col">
                    <h3 id="header-user-name" class="text-sm font-bold text-gray-800 m-0 leading-tight">Carregando...</h3>
                    <span id="header-user-email" class="text-xs text-gray-500">...</span>
                </div>
            </div>

        </div>

       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
        <div>
            <h2 class="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center">
                <i data-feather="search" class="w-4 h-4 mr-2"></i> Pesquisa Direta
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="w-full">
                    <label class="text-xs text-gray-400 mb-1 block">Data Início</label>
                    <input type="date" id="pesquisa-data-inicio" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-gray-600">
                </div>
                <div class="w-full">
                    <label class="text-xs text-gray-400 mb-1 block">Data Final</label>
                    <input type="date" id="pesquisa-data-fim" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-gray-600">
                </div>
                
                <div class="relative">
                    <input type="text" id="pesquisa-nome" placeholder="Nome do Beneficiário" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="user" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <input type="text" id="pesquisa-cpf" placeholder="CPF" class="w-full pl-10 pr-4 py-2 cpf-masck border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="credit-card" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <input type="text" id="pesquisa-cidade" placeholder="Cidade" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="map-pin" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <select id="pesquisa-status" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-600 text-sm">
                        <option value="">Todos os status</option>
                        <option value="1">Em análise</option>
                        <option value="2">Pendente</option>
                        <option value="3">Indeferido</option>
                        <option value="4">Aprovado</option>
                        <option value="5">Entregue</option>
                        <option value="6">Enviadas para Confecção</option>
                        <option value="7">Entregue aos Correios</option>
                        <option value="8">Entregue ao Município</option>
                        <option value="9">Disponível para Retirada</option>
                        <option value="10">Em Processamento</option>
                        <option value="11">Vencido</option>
                    </select>
                    <i data-feather="activity" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
            </div>
        </div>
        
        <div class="mt-4 flex justify-end">
            <button id="btn-buscar-periodo" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center transition-colors w-full md:w-auto justify-center">
                <i data-feather="search" class="w-4 h-4 mr-2"></i> Buscar
            </button>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between">
        <div>
            <h2 class="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center">
                <i data-feather="filter" class="w-4 h-4 mr-2"></i> Filtros de Dados
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8"> <div class="relative">
                    <input type="text" id="search-nome" placeholder="Nome do Beneficiário" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="user" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <input type="text" id="search-cpf" placeholder="CPF" class="w-full pl-10 pr-4 py-2 cpf-masck border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="credit-card" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <input type="text" id="search-cidade" placeholder="Cidade" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <i data-feather="map-pin" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
                <div class="relative">
                    <select id="search-status" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-600 text-sm">
                        <option value="">Todos os status</option>
                        <option value="1">Em análise</option>
                        <option value="2">Pendente</option>
                        <option value="3">Indeferido</option>
                        <option value="4">Aprovado</option>
                        <option value="5">Entregue</option>
                        <option value="6">Enviadas para Confecção</option>
                        <option value="7">Entregue aos Correios</option>
                        <option value="8">Entregue ao Município</option>
                        <option value="9">Disponível para Retirada</option>
                        <option value="10">Em Processamento</option>
                        <option value="11">Vencido</option>
                    </select>
                    <i data-feather="activity" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
            </div>
        </div>
        
        <div class="mt-4 flex justify-end">
            <button id="btn-filtrar" class="bg-blue-800 hover:bg-blue-900 text-white px-6 py-2 rounded-lg flex items-center transition-colors w-full md:w-auto justify-center">
                <i data-feather="filter" class="w-4 h-4 mr-2"></i> Filtrar Resultados
            </button>
        </div>
    </div>

</div>

        <div class="bg-white rounded-xl min-h-[500px] shadow-md overflow-hidden border border-gray-100">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">CPF</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Cidade</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Deficiência</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Data da Solicitação</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Ações</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="beneficiarios-table">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="flex flex-col md:flex-row md:justify-between md:items-center mt-4 gap-3 bg-white p-3 rounded-lg shadow-sm">
            <div class="text-sm text-gray-600">
                Mostrando <span id="range-start" class="font-bold">0</span> a <span id="range-end" class="font-bold">0</span> de <span id="total-count" class="font-bold">0</span> beneficiários
            </div>
            <div class="flex items-center gap-3 flex-wrap justify-center">
                <div class="text-sm text-gray-600">
                    <span id="page-info">Página 1 de 1</span>
                </div>
                <div class="flex items-center gap-2">
                    <label for="page-size" class="text-sm text-gray-600">exibir:</label>
                    <select id="page-size" class="px-2 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="flex space-x-1">
                    <button id="btn-first" class="p-2 border rounded-md text-blue-600 hover:bg-blue-50 disabled:opacity-50 transition-colors" disabled><i data-feather="chevrons-left" class="w-4 h-4"></i></button>
                    <button id="btn-prev" class="p-2 border rounded-md text-blue-600 hover:bg-blue-50 disabled:opacity-50 transition-colors" disabled><i data-feather="chevron-left" class="w-4 h-4"></i></button>
                    <button id="btn-next" class="p-2 border rounded-md text-blue-600 hover:bg-blue-50 disabled:opacity-50 transition-colors" disabled><i data-feather="chevron-right" class="w-4 h-4"></i></button>
                    <button id="btn-last" class="p-2 border rounded-md text-blue-600 hover:bg-blue-50 disabled:opacity-50 transition-colors" disabled><i data-feather="chevrons-right" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-blue-50">
                    <h5 class="modal-title text-blue-600 font-bold">Dados do Beneficiário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="mb-3 p-2 bg-gray-50 rounded flex justify-between items-center">
                        <div>
                            <label class="fw-bold text-gray-500 text-xs uppercase">ID do Sistema:</label>
                            <span id="view-id" class="text-sm font-mono text-gray-700"></span>
                        </div>
                        <div class="text-end">
                            <span id="view-gestor" class="text-sm badge bg-light text-dark border me-1">Gestor</span>
                            <span id="view-status" class="badge bg-secondary">Status</span>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="fw-bold text-gray-500">Nome Completo:</label>
                            <p id="view-nome" class="text-dark border-bottom pb-1"></p>
                        </div>
                        </div>
                    <div class="col-12 mt-3">
                        <label class="fw-bold text-amber-600 mb-1"><i data-feather="message-square" class="w-4 h-4 inline"></i> Observações (Admin):</label>
                        <div class="p-3 bg-yellow-50 rounded border border-yellow-200 text-sm text-gray-700" id="view-obs" style="white-space: pre-wrap; min-height: 60px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-warning text-white" id="btn-switch-to-edit" data-bs-dismiss="modal">
                        <i data-feather="edit" class="w-4 h-4 inline mr-1"></i> Editar Dados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-red-50">
                    <h5 class="modal-title text-red-600 font-bold">Excluir Cadastro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3 text-red-500 d-flex justify-content-center">
                        <i data-feather="alert-triangle" style="width: 50px; height: 50px;"></i>
                    </div>
                    <h4 class="h5">Tem certeza que deseja deletar o cadastro?</h4>
                    <input type="hidden" id="delete-id">
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Sim, Deletar</button>
                </div>
            </div>
        </div>
    </div>

    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>

    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
      new window.VLibras.Widget("https://vlibras.gov.br/app");
    </script>

    <custom-accessibility></custom-accessibility>
    <script src="../../components/accessibility.js"></script>
    
    <custom-footer></custom-footer>
    <script src="../../components/footer.js"></script>

    <script type="module" src="./listarBeneficiarios.js"></script>
    <script type="module" src="./atualizarBeneficiario.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>